---
# Role: base - Configuración base del sistema

- name: Configurar timezone
  community.general.timezone:
    name: "{{ system_timezone }}"
  tags: ['timezone']

- name: Asegurar que el directorio de locales existe
  ansible.builtin.file:
    path: /var/lib/locales/supported.d
    state: directory
    mode: '0755'
  tags: ['locale']

- name: Configurar locale español (es_ES.UTF-8)
  community.general.locale_gen:
    name: "{{ system_locale }}"
    state: present
  tags: ['locale']

- name: Establecer locale por defecto en /etc/default/locale
  ansible.builtin.copy:
    dest: /etc/default/locale
    content: |
      LANG={{ system_locale }}
      LANGUAGE={{ system_locale.split('.')[0] }}
      LC_ALL={{ system_locale }}
    mode: '0644'
  tags: ['locale']

- name: Actualizar locale con update-locale
  ansible.builtin.command: update-locale LANG={{ system_locale }} LANGUAGE={{ system_locale.split('.')[0] }} LC_ALL={{ system_locale }}
  changed_when: true
  tags: ['locale']

- name: Verificar locale configurado
  ansible.builtin.command: locale
  register: locale_output
  changed_when: false
  tags: ['locale']

- name: Mostrar configuración de locale
  ansible.builtin.debug:
    msg: "{{ locale_output.stdout_lines }}"
  tags: ['locale']

- name: Instalar paquetes base esenciales
  ansible.builtin.apt:
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - wget
      - gnupg
      - software-properties-common
      - python3
      - python3-pip
      - git
      - vim
      - nano
      - htop
      - net-tools
      - openssh-server
      - rsync
      - unzip
      - zip
      - build-essential
    state: present
    update_cache: false
  tags: ['packages']

- name: Instalar dependencias de XFCE y sistema gráfico
  ansible.builtin.apt:
    name:
      - xfce4
      - xfce4-goodies
      - xfce4-screensaver
      - lightdm
      - lightdm-gtk-greeter
      - dbus-x11
    state: present
  tags: ['packages', 'xfce']

- name: Actualizar todos los paquetes del sistema
  ansible.builtin.apt:
    upgrade: dist
    update_cache: true
  tags: ['upgrade']
  when: perform_system_upgrade | default(true)

- name: Configurar teclado del sistema (Español con layout Windows)
  ansible.builtin.copy:
    dest: /etc/default/keyboard
    content: |
      XKBMODEL="pc105"
      XKBLAYOUT="{{ system_keyboard_layout }}"
      XKBVARIANT="winkeys"
      XKBOPTIONS=""
      BACKSPACE="guess"
    mode: '0644'
  tags: ['keyboard']

- name: Crear directorio para scripts personalizados
  ansible.builtin.file:
    path: /opt/scripts
    state: directory
    mode: '0755'
  tags: ['directories']

- name: Crear directorio para logs personalizados
  ansible.builtin.file:
    path: /var/log/clarel
    state: directory
    mode: '0755'
  tags: ['directories']

- name: Configurar hostname si está definido
  ansible.builtin.hostname:
    name: "{{ inventory_hostname }}"
  when: inventory_hostname != "localhost"
  tags: ['hostname']

- name: Habilitar servicio SSH
  ansible.builtin.systemd:
    name: ssh
    enabled: true
    state: started
  tags: ['services']

- name: Configurar MOTD personalizado
  ansible.builtin.copy:
    dest: /etc/motd
    content: |
      ╔═══════════════════════════════════════════════════════╗
      ║                                                       ║
      ║          Sistema Xubuntu - Configurado por Clarel    ║
      ║                                                       ║
      ║  Este sistema está gestionado por Ansible            ║
      ║  Cualquier cambio manual puede ser sobrescrito       ║
      ║                                                       ║
      ╚═══════════════════════════════════════════════════════╝
    mode: '0644'
  tags: ['motd']
