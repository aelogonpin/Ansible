---
# Role: software - Instalación de software y aplicaciones

- name: Instalar dependencias comunes para software
  ansible.builtin.apt:
    name:
      - wget
      - curl
      - apt-transport-https
      - gnupg2
      - ca-certificates
      - software-properties-common
      - xdg-user-dirs
    state: present
  tags: ['software', 'dependencies']

# Subversion (SVN)
- name: Instalar Subversion
  ansible.builtin.apt:
    name: subversion
    state: present
  tags: ['software', 'subversion', 'svn']

# Google Chrome
- name: Instalar Google Chrome
  ansible.builtin.include_tasks: chrome.yml
  tags: ['software', 'chrome']

# Teclado virtual Onboard
- name: Instalar teclado virtual Onboard
  ansible.builtin.include_tasks: onboard.yml
  tags: ['software', 'onboard']

# Rustdesk
- name: Instalar Rustdesk
  ansible.builtin.include_tasks: rustdesk.yml
  tags: ['software', 'rustdesk']

# Grafana Alloy
- name: Instalar Grafana Alloy
  ansible.builtin.include_tasks: alloy.yml
  tags: ['software', 'alloy']

# CMZ - Añadir aquí cuando se conozcan los detalles
# - name: Instalar CMZ
#   ansible.builtin.include_tasks: cmz.yml
#   tags: ['software', 'cmz']

- name: Actualizar directorios XDG para todos los usuarios
  ansible.builtin.shell: |
    sudo -u {{ item }} xdg-user-dirs-update
  loop:
    - soporte
    - tienda
    - instalador
  changed_when: false
  tags: ['software', 'desktop', 'xdg']

- name: Crear directorio de escritorio usando xdg-user-dir para todos los usuarios
  ansible.builtin.shell: |
    DESKTOP_DIR=$(sudo -u {{ item }} xdg-user-dir DESKTOP)
    mkdir -p "$DESKTOP_DIR"
    chown {{ item }}:{{ item }} "$DESKTOP_DIR"
    chmod 0755 "$DESKTOP_DIR"
  loop:
    - soporte
    - tienda
    - instalador
  changed_when: false
  tags: ['software', 'desktop']

- name: Copiar acceso directo de Chrome al escritorio (usando xdg-user-dir)
  ansible.builtin.shell: |
    DESKTOP_DIR=$(sudo -u {{ item }} xdg-user-dir DESKTOP)
    cp -f /usr/share/applications/google-chrome.desktop "$DESKTOP_DIR/google-chrome.desktop"
    chown {{ item }}:{{ item }} "$DESKTOP_DIR/google-chrome.desktop"
    chmod 0755 "$DESKTOP_DIR/google-chrome.desktop"
  loop:
    - soporte
    - tienda
    - instalador
  changed_when: true
  tags: ['software', 'desktop', 'chrome']

- name: Copiar acceso directo de Rustdesk al escritorio (usando xdg-user-dir)
  ansible.builtin.shell: |
    DESKTOP_DIR=$(sudo -u {{ item }} xdg-user-dir DESKTOP)
    if [ -f /usr/share/applications/rustdesk.desktop ]; then
      cp -f /usr/share/applications/rustdesk.desktop "$DESKTOP_DIR/rustdesk.desktop"
      chown {{ item }}:{{ item }} "$DESKTOP_DIR/rustdesk.desktop"
      chmod 0755 "$DESKTOP_DIR/rustdesk.desktop"
    fi
  loop:
    - soporte
    - tienda
    - instalador
  changed_when: true
  ignore_errors: true
  tags: ['software', 'desktop', 'rustdesk']

- name: Marcar archivos .desktop como confiables (Chrome) - XFCE 4.18+
  ansible.builtin.shell: |
    DESKTOP_DIR=$(sudo -u {{ item }} xdg-user-dir DESKTOP)
    FILE="$DESKTOP_DIR/google-chrome.desktop"
    if [ -f "$FILE" ]; then
      CHECKSUM=$(sha256sum "$FILE" | awk '{print $1}')
      sudo -u {{ item }} dbus-launch gio set -t string "$FILE" metadata::xfce-exe-checksum "$CHECKSUM" 2>/dev/null || true
    fi
  loop:
    - soporte
    - tienda
    - instalador
  changed_when: false
  ignore_errors: true
  tags: ['software', 'desktop', 'chrome']

- name: Marcar archivos .desktop como confiables (Rustdesk) - XFCE 4.18+
  ansible.builtin.shell: |
    DESKTOP_DIR=$(sudo -u {{ item }} xdg-user-dir DESKTOP)
    FILE="$DESKTOP_DIR/rustdesk.desktop"
    if [ -f "$FILE" ]; then
      CHECKSUM=$(sha256sum "$FILE" | awk '{print $1}')
      sudo -u {{ item }} dbus-launch gio set -t string "$FILE" metadata::xfce-exe-checksum "$CHECKSUM" 2>/dev/null || true
    fi
  loop:
    - soporte
    - tienda
    - instalador
  changed_when: false
  ignore_errors: true
  tags: ['software', 'desktop', 'rustdesk']

- name: Limpiar paquetes .deb descargados
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - /tmp/google-chrome-stable_current_amd64.deb
    - /tmp/rustdesk.deb
  tags: ['software', 'cleanup']
